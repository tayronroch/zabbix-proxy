# ========================================
# ZABBIX 7.0 LTS - PAR√ÇMETROS PROXY vs SERVER
# Guia completo de diferen√ßas de configura√ß√£o
# ========================================

# ========================================
# IMPORTANTE - REGRA FUNDAMENTAL
# ========================================

ZABBIX PROXY √© um COLETOR DE DADOS
- Coleta dados dos dispositivos monitorados
- Envia dados para o Zabbix Server
- N√ÉO processa triggers, eventos ou alertas
- N√ÉO possui interface web
- Configura√ß√£o mais simples e focada

ZABBIX SERVER √© o PROCESSADOR CENTRAL
- Recebe dados dos proxies e agentes
- Processa triggers e gera eventos
- Envia alertas e notifica√ß√µes
- Possui interface web completa
- Configura√ß√£o complexa e completa

# ========================================
# PAR√ÇMETROS COMUNS (PROXY E SERVER)
# ========================================

## CONFIGURA√á√ïES B√ÅSICAS
Hostname                    # Nome √∫nico do componente
Server                      # IP/DNS do servidor (apenas proxy)
ListenPort                  # Porta de escuta (padr√£o: 10051)
ListenIP                    # IP de escuta
SourceIP                    # IP de origem para conex√µes

## CONFIGURA√á√ïES DE DATABASE
DBHost                      # Host do banco de dados
DBName                      # Nome do banco de dados
DBUser                      # Usu√°rio do banco
DBPassword                  # Senha do banco
DBSocket                    # Socket do banco (Unix)
DBPort                      # Porta do banco

## CONFIGURA√á√ïES DE CACHE
CacheSize                   # Cache de configura√ß√£o (128K-64G)
HistoryCacheSize           # Cache de hist√≥rico (128K-16G)
HistoryIndexCacheSize      # Cache de √≠ndice (128K-16G)
VMwareCacheSize            # Cache VMware (256K-2G)

## CONFIGURA√á√ïES DE PROCESSOS B√ÅSICOS
StartPollers               # Pollers principais (0-1000)
StartIPMIPollers           # Pollers IPMI (0-1000)
StartPollersUnreachable    # Pollers para hosts inacess√≠veis (0-1000)
StartTrappers              # Receptores de dados ativos (0-1000)
StartPingers               # Processos de ping (0-1000) 
StartDiscoverers           # Processos de descoberta (0-1000)
StartHTTPPollers           # Pollers HTTP (0-1000)
StartPreprocessors         # Preprocessadores (1-1000)
StartDBSyncers             # Sincronizadores DB (1-100)

## CONFIGURA√á√ïES DE TIMEOUT
Timeout                    # Timeout de conex√£o (1-30s)
TrapperTimeout             # Timeout de trappers (1-300s)
UnreachableDelay           # Delay para inacess√≠veis (1-3600s)
UnreachablePeriod          # Per√≠odo inacess√≠vel (1-3600s)
UnavailableDelay           # Delay para indispon√≠veis (1-3600s)

## CONFIGURA√á√ïES DE LOG
LogType                    # Tipo de log (system/file/console)
LogFile                    # Arquivo de log
LogFileSize                # Tamanho do arquivo de log (0-1024MB)
LogFileCount               # Quantidade de arquivos de log (1-255)
DebugLevel                 # N√≠vel de debug (0-5)
LogSlowQueries             # Log de queries lentas (0-3600000ms)

## CONFIGURA√á√ïES DE SEGURAN√áA
AllowRoot                  # Permitir execu√ß√£o como root (0/1)
User                       # Usu√°rio para executar o processo
Include                    # Arquivos de configura√ß√£o adicionais

## CONFIGURA√á√ïES DE REDE E SNMP
SNMPTrapperFile           # Arquivo para SNMP traps
StartSNMPTrapper          # Receptor SNMP (0/1)
FpingLocation             # Localiza√ß√£o do fping
Fping6Location            # Localiza√ß√£o do fping6

## CONFIGURA√á√ïES DE SCRIPTS
ExternalScripts           # Diret√≥rio de scripts externos
AlertScriptsPath          # Diret√≥rio de scripts de alerta

# ========================================
# PAR√ÇMETROS EXCLUSIVOS DO ZABBIX PROXY
# ========================================

## CONFIGURA√á√ïES DE MODO PROXY
ProxyMode                  # Modo do proxy (0=ativo, 1=passivo)
ConfigFrequency           # Frequ√™ncia de sincroniza√ß√£o (1-604800s)
DataSenderFrequency       # Frequ√™ncia de envio (1-3600s)

## CONFIGURA√á√ïES DE BUFFER (ZABBIX 7.0)
ProxyLocalBuffer          # Buffer local (0-720h)
ProxyOfflineBuffer        # Buffer offline (1-720h)
ProxyBufferMode           # Modo buffer (disk/memory/hybrid)
ProxyMemoryBufferSize     # Tamanho buffer mem√≥ria (0,128K-2G)
ProxyMemoryBufferAge      # Idade m√°xima buffer (1-86400s)

## CONFIGURA√á√ïES DE HEARTBEAT
HeartbeatFrequency        # Frequ√™ncia heartbeat (0-3600s)

# ========================================
# PAR√ÇMETROS EXCLUSIVOS DO ZABBIX SERVER
# ========================================

## PROCESSAMENTO DE DADOS E TRIGGERS
StartAlerters             # Processos de alerta (1-100)
StartTimers               # Processos de timer (1-1000)
StartEscalators           # Processos de escalation (1-100)

## PROCESSAMENTO AVAN√áADO (ZABBIX 7.0+)
StartHistoryPollers       # Pollers de hist√≥rico (0-1000)
StartLLDProcessors        # Processadores LLD (1-100)
StartConnectors           # Conectores para integra√ß√£o (0-1000)
StartReportWriters        # Escritores de relat√≥rio (0-100)
StartServiceManager       # Gerenciador de servi√ßos (0-1)

## GEST√ÉO DE PROXIES
StartProxyPollers         # Pollers para proxies passivos (0-250)
ProxyConfigFrequency      # Frequ√™ncia config para proxies (1-604800s)
ProxyDataFrequency        # Frequ√™ncia dados de proxies (1-3600s)

## CONFIGURA√á√ïES DE HOUSEKEEPING
HousekeepingFrequency     # Frequ√™ncia limpeza (0-24h)
MaxHousekeeperDelete      # Max registros deletados por ciclo
DeleteExpiredExportedPeriod # Per√≠odo para deletar exports expirados

## CONFIGURA√á√ïES WEB E API
WebDriverURL              # URL do driver web para testes
SSHKeyLocation            # Localiza√ß√£o das chaves SSH
SSLCertLocation           # Localiza√ß√£o certificado SSL
SSLKeyLocation            # Localiza√ß√£o chave SSL
SSLCALocation             # Localiza√ß√£o CA SSL

## CONFIGURA√á√ïES DE ALTA DISPONIBILIDADE
HANodeName                # Nome do n√≥ HA
NodeAddress               # Endere√ßo do n√≥

## CONFIGURA√á√ïES DE VAULT (SEGREDOS)
VaultDBPath               # Caminho do DB no Vault
VaultURL                  # URL do HashiCorp Vault

## CONFIGURA√á√ïES DE AUDITORIA E COMPLIANCE
AuditLogEnabled           # Habilitar log de auditoria (0/1)

## PROCESSADORES JAVA E VMWARE
StartJavaPollers          # Pollers Java (0-1000)
JavaGateway               # Gateway Java
JavaGatewayPort           # Porta do gateway Java
StartJavaPollers          # N√∫mero de pollers Java

StartVMwareCollectors     # Coletores VMware (0-250)
VMwareFrequency           # Frequ√™ncia coleta VMware (10-86400s)
VMwarePerfFrequency       # Frequ√™ncia performance VMware (10-86400s)
VMwareCacheSize           # Cache VMware (256K-2G)
VMwareTimeout             # Timeout VMware (1-300s)

## OUTROS PROCESSADORES ESPECIALIZADOS
StartSNMPPollers          # Pollers SNMP espec√≠ficos (0-1000)
StartAgentPollers         # Pollers de agentes (0-1000)
StartHTTPAgentPollers     # Pollers HTTP Agent (0-1000)
StartBrowserPollers       # Pollers de browser (0-1000)
StartODBCPollers          # Pollers ODBC (0-1000)

# ========================================
# PAR√ÇMETROS INV√ÅLIDOS PARA PROXY
# ========================================
# ATEN√á√ÉO: Estes causam ERRO no Zabbix Proxy!

StartHistoryPollers       # ‚ùå ERRO: "unknown parameter"
StartLLDProcessors        # ‚ùå ERRO: "unknown parameter"  
StartTaskManager          # ‚ùå ERRO: "unknown parameter"
StartAlertManagers        # ‚ùå ERRO: "unknown parameter"
StartAvailabilityReportWriters # ‚ùå ERRO: "unknown parameter"
StartSNMPTrappers         # ‚ùå ERRO: "unknown parameter"
StartAlerters             # ‚ùå ERRO: exclusivo do server
StartTimers               # ‚ùå ERRO: exclusivo do server
StartEscalators           # ‚ùå ERRO: exclusivo do server
StartConnectors           # ‚ùå ERRO: exclusivo do server
StartProxyPollers         # ‚ùå ERRO: exclusivo do server
HousekeepingFrequency     # ‚ùå ERRO: exclusivo do server
BufferSize                # ‚ùå ERRO: par√¢metro de agent, n√£o proxy
BufferSend                # ‚ùå ERRO: par√¢metro de agent, n√£o proxy

# ========================================
# CONFIGURA√á√ïES RECOMENDADAS POR CEN√ÅRIO
# ========================================

## PROXY PEQUENO (< 1000 itens)
CacheSize=128M
HistoryCacheSize=64M
StartPollers=10
StartPreprocessors=2

## PROXY M√âDIO (1000-10000 itens)
CacheSize=512M
HistoryCacheSize=256M
StartPollers=50
StartPreprocessors=5

## PROXY GRANDE (10000-50000 itens)
CacheSize=2G
HistoryCacheSize=1G
StartPollers=100
StartPreprocessors=10

## PROXY MUITO GRANDE (50000+ itens)
CacheSize=4G
HistoryCacheSize=2G
StartPollers=200
StartPreprocessors=20

# ========================================
# CONFIGURA√á√ïES DE BUFFER ZABBIX 7.0
# ========================================

## MODO DISK (Padr√£o instala√ß√µes antigas)
ProxyBufferMode=disk
ProxyLocalBuffer=0
ProxyOfflineBuffer=1

## MODO HYBRID (Recomendado para Zabbix 7.0)
ProxyBufferMode=hybrid
ProxyMemoryBufferSize=512M
ProxyMemoryBufferAge=5
ProxyLocalBuffer=0

## MODO MEMORY (Alto desempenho, sem prote√ß√£o)
ProxyBufferMode=memory
ProxyMemoryBufferSize=1G
ProxyMemoryBufferAge=3
ProxyLocalBuffer=0

# ========================================
# MONITORAMENTO INTERNO RECOMENDADO
# ========================================

## Para PROXY - Itens internos importantes:
zabbix[proxy,config,cache,pused]          # Uso cache configura√ß√£o
zabbix[proxy,history,cache,pused]         # Uso cache hist√≥rico
zabbix[proxy,buffer,pused]                # Uso buffer dados
zabbix[proxy,status]                      # Status conex√£o server
zabbix[proxy,buffer_mode]                 # Modo do buffer atual

## Para SERVER - Itens internos importantes:
zabbix[host,config,cache,pused]           # Uso cache configura√ß√£o
zabbix[history,cache,pused]               # Uso cache hist√≥rico
zabbix[index,cache,pused]                 # Uso cache √≠ndice
zabbix[queue]                             # Fila de itens pendentes
zabbix[status]                            # Status geral do server

# ========================================
# TROUBLESHOOTING COMUM
# ========================================

## ERROS DE CONFIGURA√á√ÉO PROXY:
"unknown parameter 'StartHistoryPollers'"  ‚Üí Remover par√¢metro (exclusivo server)
"unknown parameter 'BufferSize'"           ‚Üí Usar ProxyMemoryBufferSize
"cannot set configuration cache size"      ‚Üí Verificar mem√≥ria dispon√≠vel
"proxy buffer mode hybrid conflicts"       ‚Üí Configurar ProxyMemoryBufferSize

## PROBLEMAS DE PERFORMANCE PROXY:
Cache utilization > 75%                    ‚Üí Aumentar CacheSize
Proxy buffer > 90%                         ‚Üí Aumentar ProxyMemoryBufferSize
Unreachable pollers > 75%                  ‚Üí Aumentar StartPollers
Queue growing constantly                    ‚Üí Aumentar StartPreprocessors

## CONFIGURA√á√ïES DE NETWORK:
StartTrappers                              ‚Üí Para dados ativos de agentes
StartPollers                               ‚Üí Para coleta passiva SNMP/Agent
StartPingers                               ‚Üí Para ICMP ping
StartHTTPPollers                           ‚Üí Para web scenarios
StartIPMIPollers                           ‚Üí Para IPMI monitoring

# ========================================
# COMANDOS √öTEIS PARA DIAGN√ìSTICO
# ========================================

## Verificar configura√ß√£o:
zabbix_proxy -c /etc/zabbix/zabbix_proxy.conf -t

## Ver estat√≠sticas internas:
zabbix_get -s proxy_ip -k "zabbix[proxy,status]"
zabbix_get -s proxy_ip -k "zabbix[proxy,config,cache,pused]"

## Monitorar logs:
tail -f /var/log/zabbix/zabbix_proxy.log

## Verificar conex√£o com server:
telnet server_ip 10051

# ========================================
# RESUMO FINAL
# ========================================

‚úÖ PROXY: Foco em coleta e cache de dados
‚ùå PROXY: N√£o processa triggers/alertas/web

‚úÖ SERVER: Processamento completo de monitoramento  
‚ùå SERVER: N√£o coleta dados diretamente (usa proxies/agents)

üîß REGRA DE OURO:
- Se √© para COLETAR dados ‚Üí Configure no PROXY
- Se √© para PROCESSAR dados ‚Üí Configure no SERVER
- Sempre teste configura√ß√£o antes de aplicar em produ√ß√£o!

# ========================================
# PARA APLICAR MUDAN√áAS NO SEU PROJETO
# ========================================

1. Editar Dockerfile.proxy removendo par√¢metros inv√°lidos
2. Usar apenas par√¢metros v√°lidos para proxy
3. Testar configura√ß√£o: docker-compose build --no-cache
4. Aplicar: docker-compose up -d
5. Monitorar logs para verificar sucesso