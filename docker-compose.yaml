version: '3.8'

# üöÄ CoreWise Zabbix Proxy + Scripts SSH - Configura√ß√£o Otimizada
# Sistema de proxy para monitoramento distribu√≠do com coleta SSH
# Otimizado para alta carga (15k+ itens) - Deploy via Coolify

services:
  zabbix-proxy:
    build:
      context: .
      dockerfile: Dockerfile.proxy
    image: corewise-zabbix-proxy:latest
    container_name: corewise-proxy
    env_file:
      - .env
    environment:
      # Configura√ß√µes b√°sicas (podem ser sobrescritas pelo .env)
      ZBX_HOSTNAME: ${ZBX_HOSTNAME:-corewise-proxy}
      ZBX_SERVER_HOST: ${ZBX_SERVER_HOST:-45.161.89.183}
      ZBX_SERVER_PORT: ${ZBX_SERVER_PORT:-10051}
      ZBX_TIMEOUT: ${ZBX_TIMEOUT:-30}
      
      # IMPORTANTE: Todas as configura√ß√µes de performance est√£o definidas
      # diretamente no zabbix_proxy.conf dentro do Dockerfile
      # N√£o usar vari√°veis ZBX_START_* pois podem n√£o ser suportadas pelo Zabbix 7.0
    
    # O Zabbix Proxy se conecta ativamente ao Zabbix Server
    # Nao precisa expor a porta 10051 externamente
    # ports:
    #   - "10051:10051/tcp"
    
    restart: unless-stopped
    
    dns:
      - ${DNS_PRIMARY:-8.8.8.8}
      - ${DNS_SECONDARY:-8.8.4.4}
    
    networks:
      - zabbix-network
    
    volumes:
      # Persistir dados do banco SQLite
      - zabbix-data:/var/lib/zabbix
      # Persistir logs
      - zabbix-logs:/var/log/zabbix
      # Melhorar performance com tmpfs para dados tempor√°rios
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 1G
    
    deploy:
      resources:
        limits:
          memory: ${CONTAINER_MEMORY_LIMIT:-8G}
          cpus: ${CONTAINER_CPU_LIMIT:-3.5}
        reservations:
          memory: ${CONTAINER_MEMORY_RESERVATION:-4G}
    
    healthcheck:
      test: ["CMD", "zabbix_get", "-s", "localhost", "-k", "zabbix[host,zabbix-proxy,available]"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    labels:
      - "coolify.managed=true"
      - "coolify.name=zabbix-proxy"
      - "coolify.description=Zabbix Proxy para monitoramento distribu√≠do - 15k+ itens"

volumes:
  zabbix-data:
    driver: local
  zabbix-logs:
    driver: local

networks:
  zabbix-network:
    driver: bridge