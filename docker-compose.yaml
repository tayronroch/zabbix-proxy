version: '3.8'

# üöÄ CoreWise Zabbix Proxy + Scripts SSH - Configura√ß√£o Otimizada
# Sistema de proxy para monitoramento distribu√≠do com coleta SSH
# Otimizado para alta carga (15k+ itens) - Deploy via Coolify

services:
  zabbix-proxy:
    build:
      context: .
      dockerfile: Dockerfile.proxy
    image: corewise-zabbix-proxy:latest
    container_name: corewise-proxy
    env_file:
      - .env
    environment:
      # Configura√ß√µes b√°sicas (podem ser sobrescritas pelo .env)
      ZBX_HOSTNAME: ${ZBX_HOSTNAME:-corewise-proxy}
      ZBX_SERVER_HOST: ${ZBX_SERVER_HOST:-45.161.89.183}
      ZBX_SERVER_PORT: ${ZBX_SERVER_PORT:-10051}
      ZBX_TIMEOUT: ${ZBX_TIMEOUT:-30}
      
      # Configura√ß√µes de buffer otimizadas
      ZBX_LOCAL_BUFFER: ${ZBX_LOCAL_BUFFER:-2880}
      ZBX_OFFLINE_BUFFER: ${ZBX_OFFLINE_BUFFER:-4320}
      
      # Configura√ß√µes de cache para alta carga (Zabbix Proxy 7.0)
      ZBX_HISTORY_CACHE_SIZE: ${ZBX_HISTORY_CACHE_SIZE:-256M}
      ZBX_HISTORY_INDEX_CACHE_SIZE: ${ZBX_HISTORY_INDEX_CACHE_SIZE:-64M}
      
      # Configura√ß√µes de processos
      ZBX_START_POLLERS: ${ZBX_START_POLLERS:-50}
      ZBX_START_PINGPOLLERS: ${ZBX_START_PINGPOLLERS:-20}
      ZBX_START_TRAPPERS: ${ZBX_START_TRAPPERS:-20}
      ZBX_START_DISCOVERERS: ${ZBX_START_DISCOVERERS:-10}
      
      # Configura√ß√µes de performance
      ZBX_UNREACHABLE_DELAY: ${ZBX_UNREACHABLE_DELAY:-60}
      ZBX_UNAVAILABLE_DELAY: ${ZBX_UNAVAILABLE_DELAY:-300}
      ZBX_HOUSEKEEPING_FREQUENCY: ${ZBX_HOUSEKEEPING_FREQUENCY:-1}
      ZBX_MAX_HOUSEKEEPER_DELETE: ${ZBX_MAX_HOUSEKEEPER_DELETE:-50000}
      
      # Configura√ß√µes de log
      ZBX_LOG_LEVEL: ${ZBX_LOG_LEVEL:-3}
      ZBX_DEBUG_LEVEL: ${ZBX_DEBUG_LEVEL:-3}
    
    # O Zabbix Proxy se conecta ativamente ao Zabbix Server
    # Nao precisa expor a porta 10051 externamente
    # ports:
    #   - "10051:10051/tcp"
    
    restart: unless-stopped
    
    dns:
      - ${DNS_PRIMARY:-8.8.8.8}
      - ${DNS_SECONDARY:-8.8.4.4}
    
    networks:
      - zabbix-network
    
    volumes:
      # Persistir dados do banco SQLite
      - zabbix-data:/var/lib/zabbix
      # Persistir logs
      - zabbix-logs:/var/log/zabbix
      # Melhorar performance com tmpfs para dados tempor√°rios
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 1G
    
    deploy:
      resources:
        limits:
          memory: ${CONTAINER_MEMORY_LIMIT:-8G}
          cpus: ${CONTAINER_CPU_LIMIT:-6.0}
        reservations:
          memory: ${CONTAINER_MEMORY_RESERVATION:-4G}
          cpus: ${CONTAINER_CPU_RESERVATION:-3.0}
    
    healthcheck:
      test: ["CMD", "zabbix_get", "-s", "localhost", "-k", "zabbix[host,zabbix-proxy,available]"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    labels:
      - "coolify.managed=true"
      - "coolify.name=zabbix-proxy"
      - "coolify.description=Zabbix Proxy para monitoramento distribu√≠do - 15k+ itens"

volumes:
  zabbix-data:
    driver: local
  zabbix-logs:
    driver: local

networks:
  zabbix-network:
    driver: bridge