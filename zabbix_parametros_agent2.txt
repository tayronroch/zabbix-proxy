# ========================================
# ZABBIX AGENT2 7.0 LTS - PAR√ÇMETROS COMPLETOS
# Guia completo de configura√ß√£o do Zabbix Agent2
# ========================================

# ========================================
# CARACTER√çSTICAS DO ZABBIX AGENT2
# ========================================

ZABBIX AGENT2 √© o agente MODERNO do Zabbix:
- Escrito em GO (substitui o Agent1 em C)
- Suporte nativo a plugins
- Melhor performance e menor uso de recursos
- Coleta paralela de dados
- Buffer persistente para dados cr√≠ticos
- Compat√≠vel com Agent1 (migra√ß√£o transparente)

# ========================================
# CONFIGURA√á√ïES GERAIS
# ========================================

## IDENTIFICA√á√ÉO DO HOST
Hostname
    Tipo: String
    Obrigat√≥rio: N√£o (pode usar HostnameItem)
    Tamanho m√°ximo: 128 caracteres por hostname
    Padr√£o: Sistema define automaticamente
    Descri√ß√£o: Nome √∫nico do host (case-sensitive)
    Exemplo: Hostname=webserver01

HostnameItem
    Tipo: String  
    Obrigat√≥rio: N√£o
    Padr√£o: system.hostname
    Descri√ß√£o: Item para obter hostname automaticamente
    Exemplo: HostnameItem=system.hostname

HostMetadata
    Tipo: String
    Obrigat√≥rio: N√£o
    Tamanho m√°ximo: 255 caracteres
    Padr√£o: Vazio
    Descri√ß√£o: Metadados opcionais do host para autoregistro
    Exemplo: HostMetadata=Linux server web

HostMetadataItem
    Tipo: String
    Obrigat√≥rio: N√£o
    Padr√£o: Vazio
    Descri√ß√£o: Item para obter metadados automaticamente
    Exemplo: HostMetadataItem=system.uname

HostInterface
    Tipo: String
    Obrigat√≥rio: N√£o
    Tamanho m√°ximo: 255 caracteres
    Padr√£o: Vazio
    Descri√ß√£o: Interface opcional do host
    Exemplo: HostInterface=eth0

HostInterfaceItem
    Tipo: String
    Obrigat√≥rio: N√£o
    Padr√£o: Vazio
    Descri√ß√£o: Item para obter interface automaticamente
    Exemplo: HostInterfaceItem=net.if.discovery

# ========================================
# CONFIGURA√á√ïES DE REDE
# ========================================

## CONFIGURA√á√ïES DE SERVIDOR
Server
    Tipo: Lista separada por v√≠rgulas
    Obrigat√≥rio: N√£o (mas recomendado)
    Padr√£o: 127.0.0.1
    Formato: IP ou DNS[:porta]
    Descri√ß√£o: Lista de servidores/proxies Zabbix permitidos
    Exemplo: Server=192.168.1.10,zabbix.empresa.com

ServerActive
    Tipo: Lista separada por v√≠rgulas
    Obrigat√≥rio: N√£o
    Padr√£o: Vazio
    Formato: IP ou DNS[:porta]
    Descri√ß√£o: Servidores para verifica√ß√µes ativas
    Exemplo: ServerActive=192.168.1.10:10051

## CONFIGURA√á√ïES DE ESCUTA
ListenPort
    Tipo: Inteiro
    Obrigat√≥rio: N√£o
    Faixa: 1024-32767
    Padr√£o: 10050
    Descri√ß√£o: Porta para escutar conex√µes do servidor
    Exemplo: ListenPort=10050

ListenIP
    Tipo: Lista separada por v√≠rgulas
    Obrigat√≥rio: N√£o
    Padr√£o: 0.0.0.0 (todas as interfaces)
    Descri√ß√£o: IPs para escutar conex√µes
    Exemplo: ListenIP=192.168.1.100,127.0.0.1

## CONFIGURA√á√ïES DE ORIGEM
SourceIP
    Tipo: String (IP)
    Obrigat√≥rio: N√£o
    Padr√£o: Vazio
    Descri√ß√£o: IP de origem para conex√µes ativas
    Exemplo: SourceIP=192.168.1.100

# ========================================
# CONFIGURA√á√ïES DE TIMEOUT E FREQU√äNCIA
# ========================================

Timeout
    Tipo: Inteiro
    Obrigat√≥rio: N√£o
    Faixa: 1-30 segundos
    Padr√£o: 3 segundos
    Descri√ß√£o: Timeout para conex√µes com servidor/proxy
    Exemplo: Timeout=10

RefreshActiveChecks
    Tipo: Inteiro
    Obrigat√≥rio: N√£o
    Faixa: 1-3600 segundos
    Padr√£o: 60 segundos
    Descri√ß√£o: Frequ√™ncia de atualiza√ß√£o de itens ativos
    Exemplo: RefreshActiveChecks=120

HeartbeatFrequency
    Tipo: Inteiro
    Obrigat√≥rio: N√£o
    Faixa: 0-3600 segundos (0=desabilitado)
    Padr√£o: 0 (desabilitado)
    Descri√ß√£o: Frequ√™ncia de heartbeat para servidor
    Exemplo: HeartbeatFrequency=60

# ========================================
# CONFIGURA√á√ïES DE BUFFER
# ========================================

BufferSize
    Tipo: Inteiro
    Obrigat√≥rio: N√£o
    Faixa: 2-65535
    Padr√£o: 1000
    Descri√ß√£o: N√∫mero m√°ximo de valores no buffer de mem√≥ria
    Nota: Inv√°lido se EnablePersistentBuffer=1
    Exemplo: BufferSize=5000

BufferSend
    Tipo: Inteiro
    Obrigat√≥rio: N√£o
    Faixa: 1-3600 segundos
    Padr√£o: 5 segundos
    Descri√ß√£o: N√£o manter dados no buffer por mais que N segundos
    Exemplo: BufferSend=10

EnablePersistentBuffer
    Tipo: Inteiro
    Obrigat√≥rio: N√£o
    Valores: 0 (desabilitado), 1 (habilitado)
    Padr√£o: 0 (desabilitado)
    Descri√ß√£o: Usar armazenamento persistente local para itens ativos
    Exemplo: EnablePersistentBuffer=1

PersistentBufferPeriod
    Tipo: String (tempo)
    Obrigat√≥rio: N√£o
    Padr√£o: 1h
    Formato: Ns, Nm, Nh, Nd (segundos, minutos, horas, dias)
    Descri√ß√£o: Per√≠odo para manter dados sem conectividade
    Exemplo: PersistentBufferPeriod=2h

PersistentBufferFile
    Tipo: String
    Obrigat√≥rio: N√£o
    Padr√£o: Vazio (arquivo tempor√°rio)
    Descri√ß√£o: Caminho do arquivo de buffer persistente
    Exemplo: PersistentBufferFile=/var/lib/zabbix/buffer.db

# ========================================
# CONFIGURA√á√ïES DE LOG
# ========================================

LogType
    Tipo: String
    Obrigat√≥rio: N√£o
    Valores: system, file, console
    Padr√£o: file
    Descri√ß√£o: Tipo de log
    Exemplo: LogType=file

LogFile
    Tipo: String
    Obrigat√≥rio: Sim (se LogType=file)
    Padr√£o: Vazio
    Descri√ß√£o: Caminho do arquivo de log
    Exemplo: LogFile=/var/log/zabbix/zabbix_agent2.log

LogFileSize
    Tipo: Inteiro
    Obrigat√≥rio: N√£o
    Faixa: 0-1024 MB (0=sem rota√ß√£o)
    Padr√£o: 1 MB
    Descri√ß√£o: Tamanho m√°ximo do arquivo de log
    Exemplo: LogFileSize=10

DebugLevel
    Tipo: Inteiro
    Obrigat√≥rio: N√£o
    Faixa: 0-5
    Padr√£o: 3
    Valores: 0=emerg√™ncia, 1=erro, 2=warning, 3=info, 4=debug, 5=trace
    Descri√ß√£o: N√≠vel de debug/verbosidade
    Exemplo: DebugLevel=3

# ========================================
# CONFIGURA√á√ïES DE SEGURAN√áA
# ========================================

## EXECU√á√ÉO SEGURA
AllowRoot
    Tipo: Inteiro
    Obrigat√≥rio: N√£o
    Valores: 0 (n√£o permitir), 1 (permitir)
    Padr√£o: 0
    Descri√ß√£o: Permitir execu√ß√£o como root
    Exemplo: AllowRoot=0

User
    Tipo: String
    Obrigat√≥rio: N√£o
    Padr√£o: zabbix
    Descri√ß√£o: Usu√°rio para executar o agent
    Exemplo: User=zabbix

## CONTROLE DE ACESSO A CHAVES
AllowKey
    Tipo: String (padr√£o regex)
    Obrigat√≥rio: N√£o
    Padr√£o: Vazio
    Descri√ß√£o: Permitir execu√ß√£o de chaves espec√≠ficas
    Exemplo: AllowKey=system.run[*]

DenyKey  
    Tipo: String (padr√£o regex)
    Obrigat√≥rio: N√£o
    Padr√£o: Vazio
    Descri√ß√£o: Negar execu√ß√£o de chaves espec√≠ficas
    Exemplo: DenyKey=system.run[rm *]

## CONFIGURA√á√ïES TLS/CRIPTOGRAFIA
TLSConnect
    Tipo: String
    Obrigat√≥rio: N√£o
    Valores: unencrypted, psk, cert
    Padr√£o: unencrypted
    Descri√ß√£o: Tipo de conex√£o para verifica√ß√µes ativas
    Exemplo: TLSConnect=psk

TLSAccept
    Tipo: Lista separada por v√≠rgulas
    Obrigat√≥rio: N√£o
    Valores: unencrypted, psk, cert
    Padr√£o: unencrypted
    Descri√ß√£o: Tipos de conex√£o aceitos
    Exemplo: TLSAccept=unencrypted,psk

TLSCAFile
    Tipo: String
    Obrigat√≥rio: N√£o
    Padr√£o: Vazio
    Descri√ß√£o: Arquivo CA para verifica√ß√£o de certificados
    Exemplo: TLSCAFile=/etc/zabbix/ca.crt

TLSCertFile
    Tipo: String
    Obrigat√≥rio: Sim (se cert usado)
    Padr√£o: Vazio
    Descri√ß√£o: Arquivo de certificado do agent
    Exemplo: TLSCertFile=/etc/zabbix/agent.crt

TLSKeyFile
    Tipo: String
    Obrigat√≥rio: Sim (se cert usado)
    Padr√£o: Vazio
    Descri√ß√£o: Arquivo de chave privada do agent
    Exemplo: TLSKeyFile=/etc/zabbix/agent.key

TLSServerCertIssuer
    Tipo: String
    Obrigat√≥rio: N√£o
    Padr√£o: Vazio
    Descri√ß√£o: Emissor permitido do certificado do servidor
    Exemplo: TLSServerCertIssuer=CN=Zabbix CA

TLSServerCertSubject
    Tipo: String
    Obrigat√≥rio: N√£o
    Padr√£o: Vazio
    Descri√ß√£o: Assunto permitido do certificado do servidor
    Exemplo: TLSServerCertSubject=CN=Zabbix Server

TLSCRLFile
    Tipo: String
    Obrigat√≥rio: N√£o
    Padr√£o: Vazio
    Descri√ß√£o: Arquivo de lista de revoga√ß√£o de certificados
    Exemplo: TLSCRLFile=/etc/zabbix/crl.pem

TLSPSKIdentity
    Tipo: String
    Obrigat√≥rio: Sim (se psk usado)
    Padr√£o: Vazio
    Descri√ß√£o: Identidade da chave pr√©-compartilhada
    Exemplo: TLSPSKIdentity=PSK001

TLSPSKFile
    Tipo: String
    Obrigat√≥rio: Sim (se psk usado)
    Padr√£o: Vazio
    Descri√ß√£o: Arquivo com chave pr√©-compartilhada
    Exemplo: TLSPSKFile=/etc/zabbix/agent.psk

# ========================================
# CONFIGURA√á√ïES DE ARQUIVO PID E SISTEMA
# ========================================

PidFile
    Tipo: String
    Obrigat√≥rio: N√£o
    Padr√£o: /tmp/zabbix_agent2.pid
    Descri√ß√£o: Arquivo de PID do processo
    Exemplo: PidFile=/var/run/zabbix/zabbix_agent2.pid

Include
    Tipo: String ou lista
    Obrigat√≥rio: N√£o
    Padr√£o: Vazio
    Descri√ß√£o: Arquivos de configura√ß√£o adicionais
    Exemplo: Include=/etc/zabbix/agent2.d/*.conf

# ========================================
# CONFIGURA√á√ïES DE PLUGINS
# ========================================

## CONFIGURA√á√ïES GERAIS DE PLUGINS
PluginTimeout
    Tipo: Inteiro
    Obrigat√≥rio: N√£o
    Faixa: 1-30 segundos
    Padr√£o: 10 segundos
    Descri√ß√£o: Timeout para conex√µes com plugins externos
    Exemplo: PluginTimeout=15

PluginSocket
    Tipo: String
    Obrigat√≥rio: N√£o
    Padr√£o: /tmp/agent.plugin.sock
    Descri√ß√£o: Socket UNIX para comunica√ß√£o com plugins
    Exemplo: PluginSocket=/var/run/zabbix/plugins.sock

## PLUGINS DE SISTEMA
Plugins.SystemRun
    Habilitado: Por padr√£o
    Descri√ß√£o: Execu√ß√£o de comandos do sistema
    LogRemoteCommands: 0/1 (log de comandos remotos)

## PLUGINS DE BANCO DE DADOS

### Plugin MySQL
Plugins.Mysql.CallTimeout
    Tipo: Inteiro
    Padr√£o: 10 segundos
    Descri√ß√£o: Timeout para queries MySQL

Plugins.Mysql.Timeout
    Tipo: Inteiro  
    Padr√£o: 10 segundos
    Descri√ß√£o: Timeout de conex√£o MySQL

### Plugin PostgreSQL
Plugins.Postgres.CallTimeout
    Tipo: Inteiro
    Padr√£o: 10 segundos
    Descri√ß√£o: Timeout para queries PostgreSQL

Plugins.Postgres.Timeout
    Tipo: Inteiro
    Padr√£o: 10 segundos
    Descri√ß√£o: Timeout de conex√£o PostgreSQL

### Plugin MongoDB
Plugins.Mongo.Timeout
    Tipo: Inteiro
    Padr√£o: 10 segundos
    Descri√ß√£o: Timeout de conex√£o MongoDB

### Plugin Redis
Plugins.Redis.Timeout
    Tipo: Inteiro
    Padr√£o: 10 segundos
    Descri√ß√£o: Timeout de conex√£o Redis

## PLUGIN DE LOG
Plugins.Log.MaxLinesPerSecond
    Tipo: Inteiro
    Obrigat√≥rio: N√£o
    Faixa: 1-10000
    Padr√£o: 20
    Descri√ß√£o: Limite de linhas processadas por segundo
    Exemplo: Plugins.Log.MaxLinesPerSecond=100

# ========================================
# PAR√ÇMETROS CUSTOMIZADOS
# ========================================

UserParameter
    Tipo: String
    Formato: chave,comando
    Obrigat√≥rio: N√£o
    Padr√£o: Vazio
    Descri√ß√£o: Par√¢metros de usu√°rio customizados
    Exemplo: UserParameter=mysql.ping,mysqladmin ping

UnsafeUserParameters
    Tipo: Inteiro
    Obrigat√≥rio: N√£o
    Valores: 0 (seguro), 1 (inseguro)
    Padr√£o: 0
    Descri√ß√£o: Permitir caracteres inseguros em par√¢metros
    Exemplo: UnsafeUserParameters=0

# ========================================
# CONFIGURA√á√ïES RECOMENDADAS POR CEN√ÅRIO
# ========================================

## SERVIDOR WEB B√ÅSICO
Server=192.168.1.10
ServerActive=192.168.1.10
Hostname=webserver01
BufferSize=2000
BufferSend=5
DebugLevel=3
LogFileSize=10

## SERVIDOR DE BANCO DE DADOS
Server=192.168.1.10
ServerActive=192.168.1.10
Hostname=dbserver01
BufferSize=5000
BufferSend=3
EnablePersistentBuffer=1
PersistentBufferPeriod=1h
Plugins.Mysql.Timeout=30

## MONITORAMENTO CR√çTICO
Server=192.168.1.10
ServerActive=192.168.1.10
Hostname=critical-server
BufferSize=10000
BufferSend=1  
EnablePersistentBuffer=1
PersistentBufferPeriod=4h
HeartbeatFrequency=30
TLSConnect=psk
TLSAccept=psk

# ========================================
# TROUBLESHOOTING COMUM
# ========================================

## PROBLEMAS DE BUFFER
"Buffer is full, cannot store persistent value"
‚Üí Aumentar BufferSize ou diminuir RefreshActiveChecks

"Failed to send buffer data"  
‚Üí Verificar conectividade com Server/ServerActive
‚Üí Verificar se BufferSend n√£o est√° muito baixo

## PROBLEMAS DE CONEX√ÉO
"Connection refused"
‚Üí Verificar se Server/ServerActive est√° correto
‚Üí Verificar se ListenPort est√° aberta no servidor

"TLS handshake failed"
‚Üí Verificar configura√ß√µes TLS (certificados, PSK)
‚Üí Verificar se TLSConnect/TLSAccept est√£o alinhados

# ========================================
# COMANDOS √öTEIS PARA DIAGN√ìSTICO
# ========================================

## Testar configura√ß√£o:
zabbix_agent2 -c /etc/zabbix/zabbix_agent2.conf -t

## Testar item espec√≠fico:
zabbix_agent2 -c /etc/zabbix/zabbix_agent2.conf -p

## Executar em foreground (debug):
zabbix_agent2 -c /etc/zabbix/zabbix_agent2.conf -f

## Verificar vers√£o e plugins:
zabbix_agent2 --version

## Testar conectividade:
zabbix_get -s agent_ip -k "agent.ping"
zabbix_get -s agent_ip -k "system.uname"

# ========================================
# RESUMO FINAL
# ========================================

‚úÖ AGENT2: Moderno, eficiente, com plugins nativos
üîß CONFIGURA√á√ÉO: Mais simples que Server/Proxy  
üöÄ PERFORMANCE: Buffer persistente e coleta paralela
üîí SEGURAN√áA: TLS nativo e controle granular de chaves
üì¶ PLUGINS: Sistema extens√≠vel para monitoramento especializado

REGRA DE OURO: Agent2 √© para COLETA de dados nos hosts monitorados!