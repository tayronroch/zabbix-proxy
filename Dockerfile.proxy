# Dockerfile para Zabbix Proxy (SQLite) + Scripts SSH
FROM ubuntu:22.04

# Definir variáveis de ambiente para não interagir
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=America/Sao_Paulo

# Instalar dependências com tratamento robusto de erros
RUN set -ex; \
    # Limpar listas existentes para prevenir conflitos
    rm -rf /var/lib/apt/lists/*; \
    # Atualizar listas de pacotes com retry
    for i in {1..3}; do \
        apt-get update && break || sleep 15; \
    done; \
    # Instalar pacotes com limpeza
    apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        openssh-client \
        curl \
        wget \
        gnupg2 \
        lsb-release \
        # Ferramentas de debug e rede
        iputils-ping \
        net-tools \
        telnet \
        dnsutils \
        traceroute \
        nmap \
        # Ferramentas SNMP
        snmp \
        snmp-mibs-downloader \
        # Ferramentas de diagnóstico
        tcpdump \
        netcat \
        htop \
        vim \
        less \
        # Ferramentas de sistema
        procps \
        lsof \
        strace \
        # Ferramentas necessarias para Zabbix
        fping \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Adicionar repositório Zabbix 7.0 LTS e instalar Zabbix Proxy + ferramentas
RUN wget -O - https://repo.zabbix.com/zabbix-official-repo.key | apt-key add - && \
    echo "deb https://repo.zabbix.com/zabbix/7.0/ubuntu $(lsb_release -cs) main" >> /etc/apt/sources.list.d/zabbix.list && \
    apt-get update && \
    apt-get install -y zabbix-proxy-sqlite3 zabbix-sender zabbix-get zabbix-agent2 && \
    apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Configurar links simbólicos para fping (Zabbix espera em /usr/sbin/)
RUN ln -sf /usr/bin/fping /usr/sbin/fping && \
    ln -sf /usr/bin/fping6 /usr/sbin/fping6 && \
    chmod +s /usr/bin/fping /usr/bin/fping6

# Instalar bibliotecas Python
RUN pip3 install --no-cache-dir \
    paramiko \
    requests \
    netmiko \
    pysnmp

# Configurar SNMP e baixar MIBs
RUN echo "mibdirs /usr/share/snmp/mibs" > /etc/snmp/snmp.conf && \
    echo "defVersion 2c" >> /etc/snmp/snmp.conf && \
    echo "defCommunity public" >> /etc/snmp/snmp.conf && \
    # Baixar MIBs padrão
    download-mibs && \
    # Baixar MIBs fundamentais que estão faltando
    cd /usr/share/snmp/mibs && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/SNMPv2-SMI.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/SNMPv2-TC.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/SNMPv2-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/SNMPv2-TM.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/IF-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/IP-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/TCP-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/UDP-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/HOST-RESOURCES-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/INET-ADDRESS-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/IANAifType-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/SNMP-FRAMEWORK-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/SNMP-MPD-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/SNMP-USER-BASED-SM-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/SNMP-VIEW-BASED-ACM-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/SNMP-COMMUNITY-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/SNMP-NOTIFICATION-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/SNMP-TARGET-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/SNMP-USM-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/SNMP-VACM-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/HOST-RESOURCES-TYPES.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/HCNUM-TC.txt || true && \
    # Baixar MIBs opcionais para eliminar warnings
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/NOTIFICATION-LOG-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/DISMAN-EVENT-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/DISMAN-SCHEDULE-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/MTA-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/NETWORK-SERVICES-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/IPV6-TC.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/IPV6-ICMP-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/IPV6-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/IPV6-TCP-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/IPV6-UDP-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/IP-FORWARD-MIB.txt || true && \
    wget -q https://raw.githubusercontent.com/net-snmp/net-snmp/master/mibs/IANA-RTPROTO-MIB.txt || true && \
    # Configurar MIBs com ordem correta
    echo "mibdirs /usr/share/snmp/mibs" > /etc/snmp/snmp.conf.new && \
    echo "defVersion 2c" >> /etc/snmp/snmp.conf.new && \
    echo "defCommunity public" >> /etc/snmp/snmp.conf.new && \
    echo "mibs SNMPv2-SMI:SNMPv2-TC:INET-ADDRESS-MIB:IPV6-TC:IANA-RTPROTO-MIB:IF-MIB:IP-MIB:TCP-MIB:UDP-MIB:HOST-RESOURCES-MIB" >> /etc/snmp/snmp.conf.new && \
    echo "mibs +ALL" >> /etc/snmp/snmp.conf.new && \
    mv /etc/snmp/snmp.conf.new /etc/snmp/snmp.conf && \
    # Criar diretório para MIBs adicionais
    mkdir -p /usr/share/snmp/mibs/custom

# Criar diretórios necessários para o Zabbix Proxy
RUN mkdir -p /run/zabbix && \
    mkdir -p /var/log/zabbix && \
    mkdir -p /var/lib/zabbix && \
    chown -R zabbix:zabbix /run/zabbix && \
    chown -R zabbix:zabbix /var/log/zabbix && \
    chown -R zabbix:zabbix /var/lib/zabbix

# Criar diretório de scripts externos
RUN mkdir -p /usr/lib/zabbix/externalscripts

# Copiar scripts para o diretório de scripts externos
COPY scripts/ /usr/lib/zabbix/externalscripts/

# Dar permissão de execução aos scripts
RUN chmod +x /usr/lib/zabbix/externalscripts/*.py && \
    chown -R zabbix:zabbix /usr/lib/zabbix/externalscripts/

# Criar script de inicialização melhorado
RUN echo '#!/bin/bash' > /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'set -e' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '# Log de inicialização' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'echo "$(date): Iniciando Zabbix Proxy..."' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '# Configurar DNS se necessário' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'if [ ! -z "$DNS_SERVER" ]; then' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '    echo "nameserver $DNS_SERVER" > /etc/resolv.conf' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'fi' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '# Verificar conectividade de rede' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'echo "$(date): Verificando conectividade..."' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'for i in {1..3}; do' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '    ping -c 1 8.8.8.8 >/dev/null 2>&1 && echo "Internet: OK" && break || echo "Tentativa $i: FAIL"' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '    sleep 5' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'done' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '# Verificar zabbix_sender' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'echo "$(date): Verificando zabbix_sender..."' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'which zabbix_sender && echo "zabbix_sender: OK" || echo "zabbix_sender: FALHA"' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '# Verificar MIBs SNMP' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'echo "$(date): Verificando MIBs SNMP..."' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'ls -la /usr/share/snmp/mibs/ | head -10' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '# Configurar servidor se fornecido' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'if [ ! -z "$ZBX_SERVER_HOST" ]; then' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '    if [ ! -z "$ZBX_SERVER_PORT" ]; then' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '        echo "Server=$ZBX_SERVER_HOST:$ZBX_SERVER_PORT" >> /etc/zabbix/zabbix_proxy.conf' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '    else' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '        echo "Server=$ZBX_SERVER_HOST" >> /etc/zabbix/zabbix_proxy.conf' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '    fi' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'fi' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '# Configurar timeout se fornecido' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'if [ ! -z "$ZBX_TIMEOUT" ]; then' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '    echo "Timeout=$ZBX_TIMEOUT" >> /etc/zabbix/zabbix_proxy.conf' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'fi' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '# Configurar buffer local' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'if [ ! -z "$ZBX_LOCAL_BUFFER" ]; then' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '    echo "ProxyLocalBuffer=$ZBX_LOCAL_BUFFER" >> /etc/zabbix/zabbix_proxy.conf' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'fi' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '# Configurar buffer offline' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'if [ ! -z "$ZBX_OFFLINE_BUFFER" ]; then' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '    echo "ProxyOfflineBuffer=$ZBX_OFFLINE_BUFFER" >> /etc/zabbix/zabbix_proxy.conf' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'fi' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '# Verificar scripts externos' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'echo "$(date): Verificando scripts externos..."' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'ls -la /usr/lib/zabbix/externalscripts/' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo '# Iniciar Zabbix Proxy' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'echo "$(date): Iniciando Zabbix Proxy..."' >> /usr/local/bin/start-zabbix-proxy.sh && \
    echo 'exec zabbix_proxy -f -c /etc/zabbix/zabbix_proxy.conf' >> /usr/local/bin/start-zabbix-proxy.sh && \
    chmod +x /usr/local/bin/start-zabbix-proxy.sh

# Criar arquivo de configuração básico
RUN echo "Hostname=corewise-proxy" > /etc/zabbix/zabbix_proxy.conf && \
    echo "LogFile=/var/log/zabbix/zabbix_proxy.log" >> /etc/zabbix/zabbix_proxy.conf && \
    echo "PidFile=/run/zabbix/zabbix_proxy.pid" >> /etc/zabbix/zabbix_proxy.conf && \
    echo "DBHost=localhost" >> /etc/zabbix/zabbix_proxy.conf && \
    echo "DBName=/var/lib/zabbix/zabbix_proxy.db" >> /etc/zabbix/zabbix_proxy.conf && \
    echo "DBUser=zabbix" >> /etc/zabbix/zabbix_proxy.conf && \
    echo "ExternalScripts=/usr/lib/zabbix/externalscripts" >> /etc/zabbix/zabbix_proxy.conf && \
    chown zabbix:zabbix /etc/zabbix/zabbix_proxy.conf

# O Zabbix Proxy se conecta ativamente ao Zabbix Server
# Nao precisa expor a porta 10051 externamente
# EXPOSE 10051

# Configurar variáveis de ambiente padrão
ENV ZBX_HOSTNAME=corewise-proxy
ENV ZBX_SERVER_HOST=0.0.0.0
ENV ZBX_SERVER_PORT=10051
ENV ZBX_TIMEOUT=30

# Comando para iniciar o Zabbix Proxy
CMD ["/usr/local/bin/start-zabbix-proxy.sh"]